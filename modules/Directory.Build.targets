<Project>

    <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.targets', '$(MSBuildThisFileDirectory)..\'))" />

    <PropertyGroup>
        <CustomModuleManifestPath Condition="'$(CustomModuleManifestPath)'==''">module.manifest</CustomModuleManifestPath>
        <CustomModuleOutputFileName Condition="'$(CustomModuleOutputFileName)'==''">$(MSBuildProjectName).cab</CustomModuleOutputFileName>
        <CustomModuleOutputFilePath Condition="'$(CustomModuleOutputFilePath)'==''">$(OutputPath)\$(CustomModuleOutputFileName)</CustomModuleOutputFilePath>
        <IntermediateCustomModuleManifestPath Condition="'$(IntermediateCustomModuleManifestPath)'==''">$(BaseIntermediateOutputPath)\module.manifest</IntermediateCustomModuleManifestPath>
        <SignScriptRelativeFilePath Condition="'$(SignScriptRelativeFilePath)'==''">..\..\.tools\sign.ps1</SignScriptRelativeFilePath>
        <MakeCabScriptRelativeFilePath Condition="'$(MakeCabScriptRelativeFilePath)'==''">..\..\.tools\makecab.ps1</MakeCabScriptRelativeFilePath>
    </PropertyGroup>

    <!-- ========== Get absolute output paths for Pack ========== -->
    <Target Name="_GetAbsoluteOutputPathsForCustomModulePack">
        <ConvertToAbsolutePath Paths="$(CustomModuleManifestPath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="CustomModuleManifestAbsolutePath" />
        </ConvertToAbsolutePath>
        <ConvertToAbsolutePath Paths="$(CustomModuleOutputFilePath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="CustomModuleOutputAbsoluteFilePath" />
        </ConvertToAbsolutePath>
        <ConvertToAbsolutePath Paths="$(IntermediateCustomModuleManifestPath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="IntermediateCustomModuleManifestAbsolutePath" />
        </ConvertToAbsolutePath>
        <ConvertToAbsolutePath Paths="$(OutputPath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="OutputAbsolutePath" />
        </ConvertToAbsolutePath>
        <ConvertToAbsolutePath Paths="$(SignScriptRelativeFilePath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="SignScriptAbsoluteFilePath" />
        </ConvertToAbsolutePath>
        <ConvertToAbsolutePath Paths="$(SignScriptRelativeFilePath)">
            <Output TaskParameter="AbsolutePaths" PropertyName="SignScriptAbsoluteFilePath" />
        </ConvertToAbsolutePath>
    </Target>

    <!-- ========== Get the output '.cab' and '.manifest' absolute file paths ========== -->
    <Target Name="_GetOutputItemsFromCustomModulePack"
            DependsOnTargets="_GetAbsoluteOutputPathsForCustomModulePack"
            Returns="@(_OutputCustomModulePackItems)">
        <PropertyGroup>
            <_OutputCustomModulePackItems>$(IntermediateCustomModuleManifestAbsolutePath);$(CustomModuleOutputAbsolutePath)</_OutputCustomModulePackItems>
        </PropertyGroup>
    </Target>

    <!-- ========== Post event targets ========== -->
    <Target Name="_CleanCustomModuleFiles"
            DependsOnTargets="_GetOutputItemsFromCustomModulePack"
            AfterTargets="Clean">
        <ItemGroup>
            <_CustomModuleFilesToDelete Include="$(_OutputCustomModulePackItems)" />
        </ItemGroup>
        <Delete Files="@(_CustomModuleFilesToDelete)" />
    </Target>

    <!-- ========== Sign build output ========== -->
    <Target Name="SignCustomModuleBuildOutput"
            AfterTargets="Build"
            DependsOnTargets="$(SignCustomModuleBuildOutputDependsOn);_GetOutputItemsFromCustomModulePack"
            Condition=" '$(PackCustomModule)' == 'true' ">
        <Exec Command="powershell -ExecutionPolicy Bypass -File $(SignScriptAbsoluteFilePath) -Filter **\*.dll" />
    </Target>

    <!-- ========== Pack ========== -->
    <Target Name="PackCustomModule"
            AfterTargets="SignCustomModuleBuildOutput"
            DependsOnTargets="$(PackCustomModuleDependsOn);SignCustomModuleBuildOutput">
        <Exec Command="powershell -ExecutionPolicy Bypass -File $(MakeCabScriptRelativeFilePath) -SourceDirectory $(OutputAbsolutePath) -OutputDirectory $(OutputAbsolutePath) -OutputFileName $(CustomModuleOutputFileName)" />
    </Target>

    <!-- ========== Sign package ========== -->
    <Target Name="SignCustomModulePackage"
            AfterTargets="PackCustomModule"
            DependsOnTargets="$(SignCustomModulePackageDependsOn);PackCustomModule">
        <Exec Command="powershell -ExecutionPolicy Bypass -File $(SignScriptAbsoluteFilePath) -Filter **\*.cab" />
    </Target>

</Project>